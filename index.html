<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalender Konten YouTube Panjang</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #fff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --primary: #0ea5e9;
      --emerald: #10b981;
      --emerald-50: #ecfdf5;
      --emerald-200: #a7f3d0;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(#fff, #f8fafc);
      color: var(--text);
      font-size: 14px
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 12px
    }

    /* Typography Responsive */
    h1 {
      font-size: clamp(20px, 4vw, 28px);
      margin: 0;
      line-height: 1.2
    }

    .muted {
      color: var(--muted);
      font-size: clamp(11px, 2.5vw, 13px);
      line-height: 1.4
    }

    /* Layout */
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
      margin-bottom: 16px
    }

    .card h2 {
      font-size: clamp(16px, 3vw, 18px);
      margin: 0
    }

    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px
    }

    .card-content {
      padding: 16px;
      overflow-x: auto
    }

    /* Buttons Responsive */
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: clamp(12px, 2.5vw, 14px);
      white-space: nowrap
    }

    button.primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary)
    }

    button.danger {
      background: var(--danger);
      color: #fff;
      border-color: var(--danger)
    }

    button.icon {
      padding: 8px;
      width: auto;
      min-width: 36px;
      display: inline-grid;
      place-items: center
    }

    /* Inputs Responsive */
    input,
    select {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: clamp(14px, 3vw, 16px);
      background: #fff;
      color: #000;
      min-height: 40px;
      width: 100%;
    }

    /* Number inputs with better formatting */
    input[type="number"] {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      letter-spacing: 0.5px;
    }

    input::placeholder {
      color: #94a3b8
    }

    /* Table Responsive */
    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 800px
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-size: clamp(12px, 2.5vw, 14px);
      white-space: nowrap;
    }

    /* Table inputs */
    table input,
    table select {
      min-height: 36px;
      font-size: clamp(12px, 2.5vw, 14px);
      padding: 6px 8px;
      border-radius: 6px;
    }

    /* Number formatting in tables */
    table input[type="number"] {
      text-align: right;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      letter-spacing: 0.3px;
    }

    thead th {
      color: var(--text);
      text-align: left;
      font-weight: 700;
      letter-spacing: .2px;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 1px 0 var(--border)
    }

    /* Chips and badges */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 8px;
      background: #f1f5f9;
      font-size: clamp(10px, 2vw, 12px);
      margin: 2px
    }

    .chip.good {
      background: var(--emerald-50);
      border-color: var(--emerald-200)
    }

    /* Stats Grid Responsive */
    .stat {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px;
      background: #fff;
      text-align: center
    }

    .stat .label {
      color: var(--muted);
      font-size: clamp(10px, 2vw, 12px);
      margin-bottom: 4px
    }

    .stat .value {
      font-size: clamp(16px, 4vw, 20px);
      font-weight: 600;
      word-break: break-all
    }

    .stat .muted {
      font-size: clamp(9px, 1.8vw, 11px)
    }

    .grid {
      display: grid;
      gap: 12px
    }

    .grid.stats {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr))
    }

    /* Header responsive */
    .header-main {
      flex: 1;
      min-width: 200px;
      margin-bottom: 12px
    }

    .header-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center
    }

    .title-input {
      font-size: clamp(18px, 4vw, 28px);
      font-weight: 800;
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      color: var(--text);
      padding: 0;
    }

    /* Control labels */
    .control-label {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: clamp(12px, 2.5vw, 14px);
      white-space: nowrap;
    }

    .control-label input {
      width: 70px;
      min-width: 60px;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap
    }

    /* Badge */
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: clamp(10px, 2vw, 12px);
      margin: 2px;
      display: inline-block;
    }

    .badge.ok {
      background: var(--emerald-50);
      border-color: var(--emerald-200);
      color: #047857
    }

    /* Attendance table */
    .attendance {
      font-size: clamp(10px, 2vw, 12px);
      min-width: 100%;
    }

    .attendance th,
    .attendance td {
      padding: 4px 2px;
      min-width: 25px;
      text-align: center;
    }

    /* Mobile specific */
    @media (max-width: 768px) {
      .container {
        padding: 8px
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }

      .card-header h2 {
        margin-bottom: 8px
      }

      .header-controls {
        justify-content: flex-start;
        width: 100%;
      }

      .control-label {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .control-label input {
        width: 80px;
      }

      button {
        padding: 10px 12px;
        min-height: 44px;
        /* Better touch target */
      }

      .actions {
        width: 100%;
        justify-content: flex-start;
      }

      /* Table mobile optimization */
      table {
        min-width: 1000px
      }

      /* Force horizontal scroll */

      .table-wrap {
        border-radius: 8px;
        border: 1px solid var(--border);
      }

      /* Larger touch targets for mobile */
      table input,
      table select {
        min-height: 40px;
        padding: 8px;
      }

      /* Stats on mobile */
      .grid.stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat .value {
        font-size: 18px;
        line-height: 1.2;
      }
    }

    /* Tablet specific */
    @media (min-width: 769px) and (max-width: 1024px) {
      .container {
        max-width: 100%;
        padding: 16px
      }

      .grid.stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .control-label input {
        width: 80px;
      }
    }

    /* Desktop */
    @media (min-width: 1025px) {
      .container {
        max-width: 1200px;
        padding: 24px
      }

      .grid.stats {
        grid-template-columns: repeat(5, 1fr);
      }

      table {
        min-width: auto
      }

      /* Allow natural table width */
    }

    /* Number formatting improvements */
    .number-large input[type="number"] {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      letter-spacing: 0.5px;
      padding-right: 8px;
    }

    /* Prevent text overflow */
    .text-truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Checklist responsive */
    .checklist-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 200px;
    }

    .checklist-wrap .chip {
      font-size: 10px;
      padding: 2px 6px;
      margin: 1px;
    }

    /* Scroll indicators */
    .table-wrap::after {
      content: "← Geser untuk melihat kolom lainnya →";
      display: block;
      text-align: center;
      color: var(--muted);
      font-size: 11px;
      padding: 8px;
      background: #f8fafc;
      border-top: 1px solid var(--border);
    }

    @media (min-width: 1025px) {
      .table-wrap::after {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="row" style="justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap">
      <div class="header-main">
        <input id="title" class="title-input" value="Kalender Konten YouTube Panjang" />
        <div class="muted">Satu video per minggu • Simpel • Tersimpan otomatis di perangkat</div>
      </div>
      <div class="header-controls">
        <label class="control-label">
          <span>Rata-rata CTR</span>
          <div class="row" style="gap:4px">
            <input id="avg_ctr" type="number" step="0.1" value="5" />
            <span>%</span>
          </div>
        </label>
        <label class="control-label">
          <span>Retention</span>
          <div class="row" style="gap:4px">
            <input id="avg_ret" type="number" step="0.1" value="45" />
            <span>%</span>
          </div>
        </label>
        <button id="btn_export">📥 Export</button>
        <label class="control-label"
          style="border:1px solid var(--border);padding:8px 10px;border-radius:8px;background:#fff;cursor:pointer">
          <span>📤 Import</span>
          <input id="file_input" type="file" accept=".csv"
            style="position:absolute;opacity:0;width:1px;height:1px;pointer-events:none" />
        </label>
        <button id="btn_clear" class="danger">🗑️ Clear</button>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <h2>📊 Ringkasan Cepat</h2>
      </div>
      <div class="card-content grid stats">
        <div class="stat">
          <div class="label">Total Views</div>
          <div id="stat_views" class="value">0</div>
        </div>
        <div class="stat">
          <div class="label">Watch Time (jam)</div>
          <div id="stat_watch" class="value">0</div>
        </div>
        <div class="stat">
          <div class="label">Rata CTR</div>
          <div id="stat_ctr" class="value">0%</div>
          <div id="stat_ctr_note" class="muted"></div>
        </div>
        <div class="stat">
          <div class="label">Rata Retention</div>
          <div id="stat_ret" class="value">0%</div>
          <div id="stat_ret_note" class="muted"></div>
        </div>
        <div class="stat">
          <div class="label">Total Revenue</div>
          <div id="stat_rev" class="value">Rp 0</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>📅 Daftar Mingguan</h2>
        <div class="actions">
          <button id="btn_add" class="primary">➕ Tambah Minggu</button>
        </div>
      </div>
      <div class="card-content">
        <div class="table-wrap">
          <table id="table_rows">
            <thead>
              <tr>
                <th style="min-width:60px">Minggu</th>
                <th style="min-width:200px">Judul / Ide 🎬</th>
                <th style="min-width:80px">Status</th>
                <th style="min-width:200px">Checklist</th>
                <th style="min-width:120px">Target Rilis</th>
                <th style="min-width:100px">Views</th>
                <th style="min-width:120px">Watch Time (jam)</th>
                <th style="min-width:80px">CTR %</th>
                <th style="min-width:100px">Retention %</th>
                <th style="min-width:120px">Revenue (Rp)</th>
                <th style="min-width:80px">Aksi</th>
              </tr>
            </thead>
            <tbody id="tbody_rows"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header row" style="justify-content:space-between;flex-wrap:wrap">
        <h2>🎯 Absen 100 Video</h2>
        <div class="muted">Selesai: <b id="absen_done">0</b> / 100</div>
      </div>
      <div class="card-content">
        <div class="table-wrap">
          <table class="attendance" id="table_absen">
            <thead>
              <tr id="absen_head"></tr>
            </thead>
            <tbody>
              <tr id="absen_checks"></tr>
              <tr id="absen_milestones"></tr>
            </tbody>
          </table>
        </div>
        <div id="gelar_wrap" class="row" style="gap:8px;margin-top:12px;flex-wrap:wrap"></div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>💡 Tips Pakai (Quick Guide)</h2>
      </div>
      <div class="card-content">
        <ul style="margin:0 0 0 18px; padding:0; line-height:1.7">
          <li><b>Tambah Minggu</b> untuk bikin baris baru; tanggal target otomatis maju 7 hari.</li>
          <li><b>Status</b> memunculkan <i>checklist</i> relevan—tinggal centang.</li>
          <li>Isi <b>CTR</b> & <b>Retention</b>; jika di atas rata-rata channel, kolom akan highlight 🎉.</li>
          <li>Data disimpan lokal. Gunakan <b>Export CSV</b> untuk backup/share.</li>
          <li>Pakai <b>Absen 100 Video</b> buat tracking konsistensi. Tiap kelipatan 10 ada <i>milestone</i> + gelar.
          </li>
          <li><b>Mobile/Tablet:</b> Geser tabel ke kiri-kanan untuk melihat semua kolom.</li>
        </ul>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'kalender-konten-youtube-panjang';
      const ATTENDANCE_KEY = 'kalender-absen-100';
      const ATTENDANCE_SIZE = 100;
      const MILESTONES = { 10: 'Pemanasan', 20: 'Konsisten Banget', 30: 'Pegang Ritme', 40: 'Maratoner', 50: 'Setengah Jalan', 60: 'Tahan Banting', 70: 'Mesin Konten', 80: 'Elite Creator', 90: 'Legend Grind', 100: 'Century Club' };
      const CHECKLIST_BY_STATUS = {
        'Ide': ["Hook jelas", "Riset keyword", "Thumbnail konsep"],
        'Riset': ["Cek kompetitor", "Cari 3 keyword turunan", "Validasi search intent"],
        'Naskah': ["Outline 5 poin", "CTA kuat", "Opening 30 detik nempel"],
        'Rekam': ["Audio clear", "B-roll cukup", "Framing rapi"],
        'Edit': ["Cut dead air", "Subtitle", "Musik halus"],
        'QA': ["Cek typo", "Pacing enak", "No clipping audio"],
        'Upload': ["Judul & Deskripsi", "Tag & Chapter", "End screen & Cards", "Thumbnail final"],
      };

      const els = {
        title: document.getElementById('title'),
        avgCTR: document.getElementById('avg_ctr'),
        avgRet: document.getElementById('avg_ret'),
        btnAdd: document.getElementById('btn_add'),
        btnExport: document.getElementById('btn_export'),
        btnClear: document.getElementById('btn_clear'),
        fileInput: document.getElementById('file_input'),
        tbody: document.getElementById('tbody_rows'),
        statViews: document.getElementById('stat_views'),
        statWatch: document.getElementById('stat_watch'),
        statCTR: document.getElementById('stat_ctr'),
        statRET: document.getElementById('stat_ret'),
        statCTRNote: document.getElementById('stat_ctr_note'),
        statRETNote: document.getElementById('stat_ret_note'),
        statRev: document.getElementById('stat_rev'),
        absenHead: document.getElementById('absen_head'),
        absenChecks: document.getElementById('absen_checks'),
        absenMilestones: document.getElementById('absen_milestones'),
        absenDone: document.getElementById('absen_done'),
        gelarWrap: document.getElementById('gelar_wrap')
      };

      let state = load() || seed();
      let absen = loadAbsen() || Array(ATTENDANCE_SIZE).fill(false);

      function seed() {
        return {
          title: 'Kalender Konten YouTube Panjang',
          channelAvg: { ctr: 5, retention: 45 },
          rows: [
            mkRow(1, 'Cara Rawat Cupang Biar Warnanya Ngejreng', 'Ide', todayISO()),
            mkRow(2, '5 Kesalahan Fatal Pemula di YouTube Shorts', 'Naskah', plus7(todayISO())),
            mkRow(3, 'Strategi Upload 1 Video Panjang per Minggu', 'Edit', plus7(plus7(todayISO())))
          ],
        };
      }
      function todayISO() { return new Date().toISOString().slice(0, 10); }
      function plus7(iso) { const d = new Date(iso); d.setDate(d.getDate() + 7); return d.toISOString().slice(0, 10); }
      function mkRow(week, idea = '', status = 'Ide', targetISO) {
        return { id: crypto.randomUUID(), week, idea, status, checklist: (CHECKLIST_BY_STATUS[status] || []).map(t => ({ text: t, done: false })), target: targetISO || todayISO(), views: '', watchTime: '', ctr: '', retention: '', revenue: '' };
      }

      function load() { try { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : null; } catch (e) { return null } }
      function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
      function loadAbsen() { try { const s = localStorage.getItem(ATTENDANCE_KEY); return s ? JSON.parse(s) : null; } catch (e) { return null } }
      function saveAbsen() { localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(absen)); }

      // Render Rows
      function render() {
        els.title.value = state.title;
        els.avgCTR.value = state.channelAvg.ctr;
        els.avgRet.value = state.channelAvg.retention;

        els.tbody.innerHTML = '';
        state.rows.forEach((r, idx) => {
          const tr = document.createElement('tr');

          tr.appendChild(tdInput('number', r.week, v => setField(r.id, 'week', Number(v || 0)), 'center'));
          tr.appendChild(tdInput('text', r.idea, v => setField(r.id, 'idea', v)));
          tr.appendChild(tdSelect(r.status, val => changeStatus(r.id, val)));
          tr.appendChild(tdChecklist(r));
          tr.appendChild(tdInput('date', r.target, v => setField(r.id, 'target', v)));
          tr.appendChild(tdInput('number', r.views, v => setField(r.id, 'views', v), 'right'));
          tr.appendChild(tdInput('number', r.watchTime, v => setField(r.id, 'watchTime', v), 'right', { step: '0.1' }));

          const ctrTd = tdInput('number', r.ctr, v => setField(r.id, 'ctr', v), 'right', { step: '0.1' });
          if (Number(r.ctr) >= Number(state.channelAvg.ctr) && r.ctr !== '') ctrTd.style.backgroundColor = 'var(--emerald-50)';
          tr.appendChild(ctrTd);

          const retTd = tdInput('number', r.retention, v => setField(r.id, 'retention', v), 'right', { step: '0.1' });
          if (Number(r.retention) >= Number(state.channelAvg.retention) && r.retention !== '') retTd.style.backgroundColor = 'var(--emerald-50)';
          tr.appendChild(retTd);

          tr.appendChild(tdInput('number', r.revenue, v => setField(r.id, 'revenue', v), 'right', { step: '1000' }));

          const tdAct = document.createElement('td');
          const ganda = btn('⟳', () => duplicateRow(r.id), '');
          ganda.title = 'Gandakan baris (minggu +1)';
          const hapus = btn('🗑', () => removeRow(r.id), 'danger');
          tdAct.appendChild(ganda); tdAct.appendChild(document.createTextNode(' ')); tdAct.appendChild(hapus);
          tr.appendChild(tdAct);
          els.tbody.appendChild(tr);
        });

        updateStats();
        renderAttendance();
      }

      function tdInput(type, value, onChange, align, attrs) {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = type; input.value = value ?? '';
        input.style.width = '100%'; input.style.textAlign = align || 'left';
        if (type === 'number') {
          input.classList.add('number-large');
          input.style.fontFamily = 'Monaco, Menlo, monospace';
        }
        if (attrs) { Object.entries(attrs).forEach(([k, v]) => input.setAttribute(k, v)); }
        input.addEventListener('input', e => onChange(e.target.value));
        td.appendChild(input); return td;
      }

      function tdSelect(value, onChange) {
        const td = document.createElement('td');
        const sel = document.createElement('select');
        sel.style.width = '100%';
        ['Ide', 'Riset', 'Naskah', 'Rekam', 'Edit', 'QA', 'Upload'].forEach(s => {
          const opt = document.createElement('option'); opt.value = s; opt.textContent = s; sel.appendChild(opt);
        });
        sel.value = value; sel.addEventListener('change', e => onChange(e.target.value));
        td.appendChild(sel); return td;
      }

      function tdChecklist(r) {
        const td = document.createElement('td');
        const wrap = document.createElement('div'); wrap.className = 'checklist-wrap';
        r.checklist.forEach((c, i) => {
          const label = document.createElement('label'); label.className = 'chip' + (c.done ? ' good' : '');

          label.style.cursor = 'pointer';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = c.done; cb.addEventListener('change', e => {
            r.checklist[i].done = e.target.checked; save(); updateStats();
            // Toggle visual
            if (e.target.checked) { label.classList.add('good'); } else { label.classList.remove('good'); }
          });
          const span = document.createElement('span'); span.textContent = c.text;
          label.appendChild(cb); label.appendChild(span); wrap.appendChild(label);
        });
        td.appendChild(wrap); return td;
      }

      function btn(txt, onClick, kind) {
        const b = document.createElement('button');
        b.textContent = txt;
        if (kind === 'danger') b.classList.add('danger');
        b.addEventListener('click', onClick);
        b.classList.add('icon');
        return b;
      }

      function setField(id, field, value) {
        state.rows = state.rows.map(r => r.id === id ? { ...r, [field]: value } : r);
        save();
        updateStats();
      }
      function changeStatus(id, newStatus) {
        state.rows = state.rows.map(r => {
          if (r.id !== id) return r;
          const need = CHECKLIST_BY_STATUS[newStatus] || [];
          const map = new Map(r.checklist.map(c => [c.text, c.done]));
          return { ...r, status: newStatus, checklist: need.map(t => ({ text: t, done: map.get(t) || false })) };
        });
        save();
        render();
      }
      function addWeek() {
        const last = state.rows[state.rows.length - 1];
        const nextWeek = last ? Number(last.week) + 1 : 1;
        const nextDate = last ? plus7(last.target) : plus7(todayISO());
        state.rows.push(mkRow(nextWeek, '', 'Ide', nextDate));
        save();
        render();
      }
      function duplicateRow(id) {
        const idx = state.rows.findIndex(r => r.id === id);
        if (idx < 0) return;
        const base = state.rows[idx];
        const copy = { ...base, id: crypto.randomUUID(), week: Number(base.week) + 1, target: plus7(base.target) };
        // Reset metric fields on duplicate to avoid double counting
        copy.views = ''; copy.watchTime = ''; copy.ctr = ''; copy.retention = ''; copy.revenue = '';
        // Reset checklist status
        copy.checklist = copy.checklist.map(c => ({ ...c, done: false }));
        state.rows.splice(idx + 1, 0, copy);
        state.rows = state.rows.map((r, i) => ({ ...r, week: i + 1 }));
        save();
        render();
      }
      function removeRow(id) {
        state.rows = state.rows.filter(r => r.id !== id);
        // Renumber weeks
        state.rows = state.rows.map((r, i) => ({ ...r, week: i + 1 }));
        save();
        render();
      }

      function currencyIDR(n) {
        try {
          const num = Number(n || 0);
          if (!isFinite(num) || num <= 0) return 'Rp 0';
          return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        } catch (e) {
          return 'Rp 0';
        }
      }

      function formatLargeNumber(n) {
        const num = Number(n || 0);
        if (!isFinite(num) || num <= 0) return '0';
        if (num >= 1_000_000) {
          return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
        } else if (num >= 1_000) {
          return (num / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
        }
        return num.toLocaleString('id-ID');
      }

      function updateStats() {
        const rows = state.rows;

        const sum = rows.reduce((acc, r) => {
          const v = Number(r.views || 0);
          const w = Number(r.watchTime || 0);
          const c = Number(r.ctr || 0);
          const t = Number(r.retention || 0);
          const rev = Number(r.revenue || 0);

          acc.views += isFinite(v) ? v : 0;
          acc.watch += isFinite(w) ? w : 0;
          acc.rev += isFinite(rev) ? rev : 0;

          if (r.ctr !== '' && isFinite(c)) { acc.ctr += c; acc.ctrN += 1; }
          if (r.retention !== '' && isFinite(t)) { acc.ret += t; acc.retN += 1; }

          if (r.ctr !== '' && isFinite(c) && c >= Number(state.channelAvg.ctr)) acc.ctrAbove += 1;
          if (r.retention !== '' && isFinite(t) && t >= Number(state.channelAvg.retention)) acc.retAbove += 1;

          // checklist progress
          const totalCk = (r.checklist || []).length;
          const doneCk = (r.checklist || []).filter(x => x.done).length;
          acc.ckTotal += totalCk;
          acc.ckDone += doneCk;

          return acc;
        }, { views: 0, watch: 0, rev: 0, ctr: 0, ret: 0, ctrN: 0, retN: 0, ctrAbove: 0, retAbove: 0, ckTotal: 0, ckDone: 0 });

        const avgCTR = sum.ctrN ? (sum.ctr / sum.ctrN) : 0;
        const avgRET = sum.retN ? (sum.ret / sum.retN) : 0;

        els.statViews.textContent = formatLargeNumber(sum.views);
        els.statWatch.textContent = (sum.watch || 0).toLocaleString('id-ID', { maximumFractionDigits: 1 });
        els.statCTR.textContent = avgCTR.toFixed(1) + '%';
        els.statRET.textContent = avgRET.toFixed(1) + '%';
        els.statRev.textContent = currencyIDR(sum.rev);

        // Notes
        const ctrAvg = Number(state.channelAvg.ctr);
        const retAvg = Number(state.channelAvg.retention);
        els.statCTRNote.textContent = sum.ctrN ? `${sum.ctrAbove}/${sum.ctrN} video ≥ rata-rata channel (${ctrAvg}%)` : 'Belum ada data CTR';
        els.statRETNote.textContent = sum.retN ? `${sum.retAbove}/${sum.retN} video ≥ rata-rata channel (${retAvg}%)` : 'Belum ada data Retention';
      }

      // Attendance (100 video)
      function renderAttendance() {
        // Header 1..100
        els.absenHead.innerHTML = '';
        for (let i = 1; i <= ATTENDANCE_SIZE; i++) {
          const th = document.createElement('th'); th.textContent = String(i); els.absenHead.appendChild(th);
        }
        // Checks
        els.absenChecks.innerHTML = '';
        for (let i = 0; i < ATTENDANCE_SIZE; i++) {
          const td = document.createElement('td');
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!absen[i];
          cb.addEventListener('change', e => {
            absen[i] = e.target.checked;
            saveAbsen();
            renderAttendance();
          });
          td.appendChild(cb);
          els.absenChecks.appendChild(td);
        }
        // Milestones
        els.absenMilestones.innerHTML = '';
        for (let i = 1; i <= ATTENDANCE_SIZE; i++) {
          const td = document.createElement('td');
          if (MILESTONES[i]) { td.textContent = '🏁'; td.title = MILESTONES[i]; }
          els.absenMilestones.appendChild(td);
        }
        // Counter + Gelar
        const done = absen.filter(Boolean).length;
        els.absenDone.textContent = String(done);

        els.gelarWrap.innerHTML = '';
        Object.entries(MILESTONES).forEach(([k, label]) => {
          if (done >= Number(k)) {
            const badge = document.createElement('span');
            badge.className = 'badge ok';
            badge.textContent = `${k} • ${label}`;
            els.gelarWrap.appendChild(badge);
          }
        });
      }

      // CSV Helpers
      function rowsToCSV(rows) {
        // Escape CSV
        const esc = (s) => {
          const str = (s ?? '').toString();
          if (/[",\n]/.test(str)) return `"${str.replace(/"/g, '""')}"`;
          return str;
        };
        const header = ['week', 'idea', 'status', 'target', 'views', 'watchTime', 'ctr', 'retention', 'revenue', 'checklist_done', 'checklist_total'];
        const lines = [header.join(',')];
        rows.forEach(r => {
          const line = [
            r.week, r.idea, r.status, r.target, r.views, r.watchTime, r.ctr, r.retention, r.revenue,
            (r.checklist || []).filter(c => c.done).length,
            (r.checklist || []).length
          ].map(esc).join(',');
          lines.push(line);
        });
        return lines.join('\n');
      }

      function download(filename, text) {
        const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a);
        a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function parseCSV(text) {
        // Very small CSV parser (no nested newlines inside quotes except standard)
        const rows = [];
        let i = 0, cur = '', inQ = false, field = [], rec = [];
        const pushField = () => { rec.push(cur); cur = ''; };
        const pushRec = () => { if (rec.length) { rows.push(rec); } rec = []; };
        while (i < text.length) {
          const ch = text[i];
          if (inQ) {
            if (ch === '"') {
              if (text[i + 1] === '"') { cur += '"'; i++; }
              else { inQ = false; }
            } else { cur += ch; }
          } else {
            if (ch === '"') { inQ = true; }
            else if (ch === ',') { pushField(); }
            else if (ch === '\n' || ch === '\r') {
              // handle \r\n or \n
              if (ch === '\r' && text[i + 1] === '\n') i++;
              pushField(); pushRec();
            } else { cur += ch; }
          }
          i++;
        }
        if (cur !== '' || rec.length) { pushField(); pushRec(); }
        return rows;
      }

      function importCSV(text) {
        const rows = parseCSV(text);
        if (!rows.length) return;
        const header = rows[0].map(h => h.trim().toLowerCase());
        const idx = (name) => header.indexOf(name);
        const out = [];
        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];
          if (!row.length) continue;
          const week = Number(row[idx('week')] || (out.length + 1));
          const idea = row[idx('idea')] ?? '';
          const status = row[idx('status')] || 'Ide';
          const target = row[idx('target')] || todayISO();
          const views = row[idx('views')] ?? '';
          const watchTime = row[idx('watchtime')] ?? row[idx('watch_time')] ?? '';
          const ctr = row[idx('ctr')] ?? '';
          const retention = row[idx('retention')] ?? '';
          const revenue = row[idx('revenue')] ?? '';
          const base = mkRow(week, idea, status, target);
          base.views = views; base.watchTime = watchTime; base.ctr = ctr; base.retention = retention; base.revenue = revenue;
          out.push(base);
        }
        // Re-number weeks sequentially
        out.sort((a, b) => Number(a.week) - Number(b.week));
        out.forEach((r, i) => r.week = i + 1);
        state.rows = out;
        save();
        render();
      }

      // Listeners
      els.btnAdd.addEventListener('click', addWeek);
      els.btnExport.addEventListener('click', () => {
        const csv = rowsToCSV(state.rows);
        const nm = (state.title || 'kalender').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
        download(`${nm}.csv`, csv);
      });
      els.btnClear.addEventListener('click', () => {
        if (confirm('Hapus semua data kalender & absen di perangkat ini?')) {
          localStorage.removeItem(STORAGE_KEY);
          localStorage.removeItem(ATTENDANCE_KEY);
          state = seed();
          absen = Array(ATTENDANCE_SIZE).fill(false);
          render();
        }
      });
      els.fileInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => importCSV(String(reader.result || ''));
        reader.readAsText(file, 'utf-8');
        // reset input so same file can be re-imported
        e.target.value = '';
      });

      // Persist title & channel avg
      els.title.addEventListener('input', e => {
        state.title = e.target.value || 'Kalender Konten YouTube Panjang';
        save();
      });
      els.avgCTR.addEventListener('input', e => {
        const v = Number(e.target.value || 0);
        state.channelAvg.ctr = isFinite(v) ? v : 0;
        save(); render();
      });
      els.avgRet.addEventListener('input', e => {
        const v = Number(e.target.value || 0);
        state.channelAvg.retention = isFinite(v) ? v : 0;
        save(); render();
      });

      // Initial render
      render();
    })();
  </script>